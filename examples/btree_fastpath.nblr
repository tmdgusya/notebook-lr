{
  "version": "1.0",
  "cells": [
    {
      "id": "cell_title",
      "type": "markdown",
      "source": "# PostgreSQL B-tree Fastpath ìµœì í™”\n\n## ëª©ì°¨\n1. B-tree ê¸°ë³¸ êµ¬ì¡°\n2. ì¼ë°˜ ì‚½ì… ê³¼ì • ë¶„ì„\n3. Fastpath ìµœì í™” í•µì‹¬ ì•„ì´ë””ì–´\n4. Fastpath 5ê°€ì§€ ì¡°ê±´\n5. ë½(Lock) ê²½ìŸê³¼ Conditional Lock\n6. ì„±ëŠ¥ ë¹„êµ ë²¤ì¹˜ë§ˆí¬\n7. ì‹¤ì œ ì‚¬ìš© ì‚¬ë¡€ & ì •ë¦¬\n\n## í•™ìŠµ ëª©í‘œ\n- B-tree ì¸ë±ìŠ¤ì˜ ì‚½ì… ê³¼ì •ì„ ì½”ë“œë¡œ ì´í•´í•œë‹¤\n- Fastpath ìµœì í™”ê°€ **ì™œ** í•„ìš”í•˜ê³  **ì–´ë–»ê²Œ** ë™ì‘í•˜ëŠ”ì§€ íŒŒì•…í•œë‹¤\n- ë‹¨ì¡° ì¦ê°€ í‚¤(monotonically increasing key) íŒ¨í„´ì—ì„œì˜ ì„±ëŠ¥ ì´ì ì„ ì‹¤í—˜ìœ¼ë¡œ í™•ì¸í•œë‹¤\n- PostgreSQL ì†ŒìŠ¤ ì½”ë“œì˜ `_bt_insertonpg` ë¡œì§ì„ ì‹œë®¬ë ˆì´ì…˜í•œë‹¤",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_btree_concept",
      "type": "markdown",
      "source": "## 1. B-tree ê¸°ë³¸ ê°œë…\n\nB-treeëŠ” **ìê¸° ê· í˜• íƒìƒ‰ íŠ¸ë¦¬**ë¡œ, ë””ìŠ¤í¬ ê¸°ë°˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” ì¸ë±ìŠ¤ êµ¬ì¡°ì…ë‹ˆë‹¤.\n\n### í•µì‹¬ ì†ì„±\n- **ì°¨ìˆ˜(order) m**: ê° ë…¸ë“œê°€ ìµœëŒ€ mê°œì˜ ìì‹ì„ ê°€ì§ˆ ìˆ˜ ìˆìŒ\n- **ìµœì†Œ ì±„ì›€**: ë£¨íŠ¸ë¥¼ ì œì™¸í•œ ëª¨ë“  ë…¸ë“œëŠ” ìµœì†Œ âŒˆm/2âŒ‰ê°œì˜ ìì‹ì„ ê°€ì§\n- **ì •ë ¬ ë³´ì¥**: í‚¤ê°€ ë…¸ë“œ ë‚´ì—ì„œ í•­ìƒ ì •ë ¬ëœ ìƒíƒœ ìœ ì§€\n- **ê· í˜•**: ëª¨ë“  ë¦¬í”„ ë…¸ë“œê°€ ê°™ì€ ê¹Šì´ì— ìœ„ì¹˜\n\n### PostgreSQLì—ì„œì˜ B-tree\n```\n[ë£¨íŠ¸ ë…¸ë“œ]           â† í•­ìƒ ë©”ëª¨ë¦¬ì— ìºì‹œë¨\n   /    \\\n[ë‚´ë¶€]  [ë‚´ë¶€]        â† ìì£¼ ì ‘ê·¼ë˜ì–´ ë²„í¼ ìºì‹œì— ì¡´ì¬\n / \\    / \\\n[ë¦¬í”„][ë¦¬í”„][ë¦¬í”„][ë¦¬í”„] â† ì‹¤ì œ ë°ì´í„° í¬ì¸í„°(TID) ì €ì¥\n```\n\në¦¬í”„ ë…¸ë“œëŠ” **ì–‘ë°©í–¥ ì—°ê²° ë¦¬ìŠ¤íŠ¸**ë¡œ ì—°ê²°ë˜ì–´ ìˆì–´ ë²”ìœ„ ìŠ¤ìº”ì´ íš¨ìœ¨ì ì…ë‹ˆë‹¤.",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_btree_impl",
      "type": "code",
      "source": "# B-tree ë…¸ë“œ ë° íŠ¸ë¦¬ êµ¬í˜„\nclass BTreeNode:\n    \"\"\"B-tree ë…¸ë“œ. ë¦¬í”„/ë‚´ë¶€ ë…¸ë“œë¥¼ ëª¨ë‘ í‘œí˜„í•©ë‹ˆë‹¤.\"\"\"\n    def __init__(self, leaf=True):\n        self.keys = []        # ì •ë ¬ëœ í‚¤ ëª©ë¡\n        self.children = []    # ìì‹ ë…¸ë“œ í¬ì¸í„° (ë¦¬í”„ê°€ ì•„ë‹Œ ê²½ìš°)\n        self.leaf = leaf      # ë¦¬í”„ ë…¸ë“œ ì—¬ë¶€\n        self.next = None      # ë‹¤ìŒ ë¦¬í”„ ë…¸ë“œ (ë¦¬í”„ ê°„ ì—°ê²° ë¦¬ìŠ¤íŠ¸)\n        self.parent = None    # ë¶€ëª¨ ë…¸ë“œ í¬ì¸í„°\n\n    def __repr__(self):\n        return f\"Node(keys={self.keys}, leaf={self.leaf})\"\n\n\nclass BTree:\n    \"\"\"ê¸°ë³¸ B-tree êµ¬í˜„ (ì°¨ìˆ˜ t = ìµœì†Œ ì°¨ìˆ˜)\"\"\"\n    def __init__(self, t=3):\n        self.root = BTreeNode(leaf=True)\n        self.t = t  # ìµœì†Œ ì°¨ìˆ˜: ë…¸ë“œë‹¹ ìµœì†Œ t-1, ìµœëŒ€ 2t-1ê°œ í‚¤\n        self.height = 0\n        self.traversal_count = 0  # íƒìƒ‰ ì‹œ ë°©ë¬¸í•œ ë…¸ë“œ ìˆ˜ ì¶”ì \n\n    def search(self, key, node=None):\n        \"\"\"í‚¤ë¥¼ íƒìƒ‰í•˜ê³  ê²½ë¡œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.\"\"\"\n        if node is None:\n            node = self.root\n        path = [node]\n        self.traversal_count = 1\n\n        while not node.leaf:\n            i = 0\n            while i < len(node.keys) and key > node.keys[i]:\n                i += 1\n            node = node.children[i]\n            path.append(node)\n            self.traversal_count += 1\n\n        return path, key in node.keys\n\n    def insert(self, key):\n        \"\"\"í‚¤ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤. í•„ìš” ì‹œ ë…¸ë“œë¥¼ ë¶„í• í•©ë‹ˆë‹¤.\"\"\"\n        root = self.root\n        if len(root.keys) == 2 * self.t - 1:\n            # ë£¨íŠ¸ê°€ ê°€ë“ ì°¼ìœ¼ë©´ ë¶„í• \n            new_root = BTreeNode(leaf=False)\n            new_root.children.append(self.root)\n            self.root.parent = new_root\n            self._split_child(new_root, 0)\n            self.root = new_root\n            self.height += 1\n            self._insert_non_full(new_root, key)\n        else:\n            self._insert_non_full(root, key)\n\n    def _split_child(self, parent, i):\n        \"\"\"parentì˜ ië²ˆì§¸ ìì‹ ë…¸ë“œë¥¼ ë¶„í• í•©ë‹ˆë‹¤.\"\"\"\n        t = self.t\n        child = parent.children[i]\n        new_node = BTreeNode(leaf=child.leaf)\n\n        # ì¤‘ê°„ í‚¤ë¥¼ ë¶€ëª¨ë¡œ ì˜¬ë¦¼\n        parent.keys.insert(i, child.keys[t - 1])\n        parent.children.insert(i + 1, new_node)\n        new_node.parent = parent\n\n        # í‚¤ ë¶„ë°°\n        new_node.keys = child.keys[t:]\n        child.keys = child.keys[:t - 1]\n\n        # ìì‹ í¬ì¸í„° ë¶„ë°° (ë‚´ë¶€ ë…¸ë“œì¸ ê²½ìš°)\n        if not child.leaf:\n            new_node.children = child.children[t:]\n            child.children = child.children[:t]\n            for c in new_node.children:\n                c.parent = new_node\n\n        # ë¦¬í”„ ë…¸ë“œ ì—°ê²° ë¦¬ìŠ¤íŠ¸ ìœ ì§€\n        if child.leaf:\n            new_node.next = child.next\n            child.next = new_node\n\n    def _insert_non_full(self, node, key):\n        \"\"\"ê°€ë“ ì°¨ì§€ ì•Šì€ ë…¸ë“œì— í‚¤ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.\"\"\"\n        if node.leaf:\n            # ë¦¬í”„ ë…¸ë“œì— ì •ë ¬ëœ ìœ„ì¹˜ì— ì‚½ì…\n            i = 0\n            while i < len(node.keys) and key > node.keys[i]:\n                i += 1\n            node.keys.insert(i, key)\n        else:\n            # ì ì ˆí•œ ìì‹ ì°¾ê¸°\n            i = 0\n            while i < len(node.keys) and key > node.keys[i]:\n                i += 1\n            if len(node.children[i].keys) == 2 * self.t - 1:\n                self._split_child(node, i)\n                if key > node.keys[i]:\n                    i += 1\n            self._insert_non_full(node.children[i], key)\n\n    def visualize(self, node=None, level=0, prefix=\"\"):\n        \"\"\"íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ ì‹œê°ì ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.\"\"\"\n        if node is None:\n            node = self.root\n            print(f\"=== B-tree (t={self.t}, height={self.height}) ===\")\n\n        indent = \"  \" * level\n        node_type = \"ğŸƒ\" if node.leaf else \"ğŸ”·\"\n        print(f\"{indent}{prefix}{node_type} {node.keys}\")\n\n        if not node.leaf:\n            for i, child in enumerate(node.children):\n                connector = \"â”œâ”€\" if i < len(node.children) - 1 else \"â””â”€\"\n                self.visualize(child, level + 1, connector)\n\nprint(\"B-tree í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ!\")\nprint(f\"ê¸°ë³¸ ìµœì†Œ ì°¨ìˆ˜: t=3 (ë…¸ë“œë‹¹ ìµœì†Œ 2ê°œ, ìµœëŒ€ 5ê°œ í‚¤)\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "B-tree í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ!\nê¸°ë³¸ ìµœì†Œ ì°¨ìˆ˜: t=3 (ë…¸ë“œë‹¹ ìµœì†Œ 2ê°œ, ìµœëŒ€ 5ê°œ í‚¤)\n"
        }
      ],
      "execution_count": 1,
      "metadata": {}
    },
    {
      "id": "cell_btree_demo",
      "type": "code",
      "source": "# B-tree ìƒì„± ë° ì‹œê°í™”\ntree = BTree(t=3)\n\n# ìˆœì°¨ì ìœ¼ë¡œ í‚¤ ì‚½ì…\nkeys_to_insert = [10, 20, 5, 6, 12, 30, 7, 17, 25, 35, 22, 27, 40, 15, 3]\nprint(\"ì‚½ì… ìˆœì„œ:\", keys_to_insert)\nprint()\n\nfor i, key in enumerate(keys_to_insert):\n    tree.insert(key)\n\nprint(\"ìµœì¢… íŠ¸ë¦¬ êµ¬ì¡°:\")\ntree.visualize()\n\n# íƒìƒ‰ í…ŒìŠ¤íŠ¸\nprint()\nfor search_key in [17, 25, 99]:\n    path, found = tree.search(search_key)\n    status = \"ë°œê²¬\" if found else \"ì—†ìŒ\"\n    print(f\"íƒìƒ‰ key={search_key}: {status}, ë°©ë¬¸ ë…¸ë“œ ìˆ˜={tree.traversal_count}, ê²½ë¡œ: {[n.keys for n in path]}\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "ì‚½ì… ìˆœì„œ: [10, 20, 5, 6, 12, 30, 7, 17, 25, 35, 22, 27, 40, 15, 3]\n\nìµœì¢… íŠ¸ë¦¬ êµ¬ì¡°:\n=== B-tree (t=3, height=1) ===\nğŸ”· [12, 25]\nâ”œâ”€ğŸƒ [3, 5, 6, 7, 10]\nâ”œâ”€ğŸƒ [15, 17, 20, 22]\nâ””â”€ğŸƒ [27, 30, 35, 40]\n\níƒìƒ‰ key=17: ë°œê²¬, ë°©ë¬¸ ë…¸ë“œ ìˆ˜=2, ê²½ë¡œ: [[12, 25], [15, 17, 20, 22]]\níƒìƒ‰ key=25: ë°œê²¬, ë°©ë¬¸ ë…¸ë“œ ìˆ˜=1, ê²½ë¡œ: [[12, 25]]\níƒìƒ‰ key=99: ì—†ìŒ, ë°©ë¬¸ ë…¸ë“œ ìˆ˜=2, ê²½ë¡œ: [[12, 25], [27, 30, 35, 40]]\n"
        }
      ],
      "execution_count": 2,
      "metadata": {}
    },
    {
      "id": "cell_normal_insert_explain",
      "type": "markdown",
      "source": "## 2. ì¼ë°˜ ì‚½ì…ì˜ O(log N) ë¹„ìš©\n\nìƒˆ í‚¤ë¥¼ ì‚½ì…í•  ë•Œ B-treeëŠ” í•­ìƒ **ë£¨íŠ¸ì—ì„œ ë¦¬í”„ê¹Œì§€** ë‚´ë ¤ê°€ì•¼ í•©ë‹ˆë‹¤:\n\n```\n1. ë£¨íŠ¸ ë…¸ë“œ ì ê¸ˆ(lock) íšë“\n2. ë£¨íŠ¸ì—ì„œ ì‹œì‘í•˜ì—¬ ì ì ˆí•œ ìì‹ ë…¸ë“œ íƒìƒ‰\n3. ê° ë ˆë²¨ì—ì„œ ì´ì§„ íƒìƒ‰ìœ¼ë¡œ ì˜¬ë°”ë¥¸ ìì‹ ì„ íƒ\n4. ë¦¬í”„ ë…¸ë“œì— ë„ë‹¬í•˜ë©´ í‚¤ ì‚½ì…\n5. ë…¸ë“œê°€ ê°€ë“ ì°¨ë©´ ë¶„í• (split) â†’ ë¶€ëª¨ë¡œ ì „íŒŒ\n```\n\n### ë¹„ìš© ë¶„ì„\n| í•­ëª© | ë¹„ìš© |\n|------|------|\n| íŠ¸ë¦¬ íƒìƒ‰ | O(log N) ë…¸ë“œ ë°©ë¬¸ |\n| ê° ë…¸ë“œì—ì„œ í‚¤ íƒìƒ‰ | O(log t) ì´ì§„ íƒìƒ‰ |\n| ë½ íšë“/í•´ì œ | ê²½ë¡œìƒ ëª¨ë“  ë…¸ë“œ |\n| ë²„í¼ í•€(pin) | ê° í˜ì´ì§€ë§ˆë‹¤ |\n\n**ë¬¸ì œ**: 1ì–µ ê°œ í–‰ì˜ í…Œì´ë¸”ì—ì„œ `SERIAL` ì»¬ëŸ¼ìœ¼ë¡œ INSERTí•˜ë©´?  \nâ†’ ë§¤ë²ˆ ë£¨íŠ¸ì—ì„œ **ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„**ê¹Œì§€ ë‚´ë ¤ê°  \nâ†’ ê²½ë¡œê°€ í•­ìƒ ë™ì¼í•œë°ë„ ë§¤ë²ˆ íƒìƒ‰  \nâ†’ **Fastpathê°€ ì´ ë‚­ë¹„ë¥¼ ì œê±°í•©ë‹ˆë‹¤!**",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_normal_insert_sim",
      "type": "code",
      "source": "# ì¼ë°˜ ì‚½ì… ì‹œ íƒìƒ‰ ê²½ë¡œ ì¶”ì  ì‹œë®¬ë ˆì´ì…˜\nclass BTreeWithStats(BTree):\n    \"\"\"í†µê³„ ìˆ˜ì§‘ì´ ê°€ëŠ¥í•œ B-tree\"\"\"\n    def __init__(self, t=3):\n        super().__init__(t)\n        self.total_nodes_visited = 0\n        self.insert_count = 0\n        self.path_log = []  # ê° ì‚½ì…ì˜ ê²½ë¡œ ê¹Šì´ ê¸°ë¡\n\n    def insert_with_tracking(self, key):\n        \"\"\"ì‚½ì…í•˜ë©´ì„œ ê²½ë¡œë¥¼ ì¶”ì í•©ë‹ˆë‹¤.\"\"\"\n        # ì‚½ì… ì „ ê²½ë¡œ íƒìƒ‰\n        path, _ = self.search(key)\n        depth = len(path)\n        self.total_nodes_visited += depth\n        self.insert_count += 1\n        self.path_log.append(depth)\n\n        # ì‹¤ì œ ì‚½ì…\n        self.insert(key)\n        return depth\n\n# ë‹¨ì¡° ì¦ê°€ í‚¤ ì‚½ì… ì‹œë®¬ë ˆì´ì…˜\nstats_tree = BTreeWithStats(t=4)\nprint(\"=== ë‹¨ì¡° ì¦ê°€ í‚¤ 1~200 ì‚½ì… ===\")\nprint(f\"{'í‚¤ ë²”ìœ„':>12} | {'í‰ê·  ê¹Šì´':>8} | {'ì´ ë°©ë¬¸':>8} | {'íŠ¸ë¦¬ ë†’ì´':>8}\")\nprint(\"-\" * 50)\n\nfor i in range(1, 201):\n    stats_tree.insert_with_tracking(i)\n    if i % 50 == 0:\n        recent = stats_tree.path_log[-50:]\n        avg = sum(recent) / len(recent)\n        print(f\"  {i-49:>3}~{i:<3}    | {avg:>8.2f} | {stats_tree.total_nodes_visited:>8} | {stats_tree.height:>8}\")\n\noverall_avg = stats_tree.total_nodes_visited / stats_tree.insert_count\nprint(f\"\\nì „ì²´ í‰ê·  ë…¸ë“œ ë°©ë¬¸ ìˆ˜: {overall_avg:.2f}\")\nprint(f\"ì´ ì‚½ì… íšŸìˆ˜: {stats_tree.insert_count}\")\nprint(f\"ì´ ë…¸ë“œ ë°©ë¬¸: {stats_tree.total_nodes_visited}\")\nprint(f\"\\nâ†’ ë‹¨ì¡° ì¦ê°€ ì‚½ì…ì„ì—ë„ ë§¤ë²ˆ ë£¨íŠ¸ë¶€í„° íƒìƒ‰!\")\nprint(f\"â†’ ëª©ì ì§€(ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„)ëŠ” í•­ìƒ ê°™ì€ë° ê²½ë¡œë¥¼ ìºì‹±í•˜ì§€ ì•ŠìŒ\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "=== ë‹¨ì¡° ì¦ê°€ í‚¤ 1~200 ì‚½ì… ===\n    í‚¤ ë²”ìœ„ | í‰ê·  ê¹Šì´ |   ì´ ë°©ë¬¸ | íŠ¸ë¦¬ ë†’ì´\n--------------------------------------------------\n    1~50    |     2.06 |      103 |        1\n   51~100   |     2.78 |      242 |        2\n  101~150   |     3.00 |      392 |        2\n  151~200   |     3.00 |      542 |        2\n\nì „ì²´ í‰ê·  ë…¸ë“œ ë°©ë¬¸ ìˆ˜: 2.71\nì´ ì‚½ì… íšŸìˆ˜: 200\nì´ ë…¸ë“œ ë°©ë¬¸: 542\n\nâ†’ ë‹¨ì¡° ì¦ê°€ ì‚½ì…ì„ì—ë„ ë§¤ë²ˆ ë£¨íŠ¸ë¶€í„° íƒìƒ‰!\nâ†’ ëª©ì ì§€(ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„)ëŠ” í•­ìƒ ê°™ì€ë° ê²½ë¡œë¥¼ ìºì‹±í•˜ì§€ ì•ŠìŒ\n"
        }
      ],
      "execution_count": 3,
      "metadata": {}
    },
    {
      "id": "cell_fastpath_concept",
      "type": "markdown",
      "source": "## 3. Fastpath ìµœì í™” í•µì‹¬ ì•„ì´ë””ì–´\n\n### ê´€ì°°\nSERIAL, BIGSERIAL, íƒ€ì„ìŠ¤íƒ¬í”„ ê°™ì€ **ë‹¨ì¡° ì¦ê°€ í‚¤**ë¡œ INSERTí•˜ë©´:\n- ìƒˆ ê°’ì€ í•­ìƒ **ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„ ë…¸ë“œ**ì— ë“¤ì–´ê°\n- ë§¤ë²ˆ ë£¨íŠ¸ â†’ ë‚´ë¶€ â†’ ... â†’ ë¦¬í”„ ê²½ë¡œë¥¼ íƒìƒ‰í•˜ëŠ” ê²ƒì€ **ë‚­ë¹„**\n\n### Fastpath ì „ëµ\n```\nì¼ë°˜ ê²½ë¡œ:   ë£¨íŠ¸ â†’ ë‚´ë¶€ë…¸ë“œ â†’ ... â†’ ë¦¬í”„  (O(log N) ë°©ë¬¸)\nFastpath:    ìºì‹œëœ ë¦¬í”„ ì§í–‰              (O(1) ë°©ë¬¸)\n```\n\n### ë™ì‘ ì›ë¦¬\n1. **ë§ˆì§€ë§‰ ì‚½ì… ë¦¬í”„ë¥¼ ìºì‹±** (`cachedBlock`)\n2. ìƒˆ ì‚½ì… ì‹œ, ìºì‹œëœ ë¦¬í”„ê°€ ìœ íš¨í•œì§€ **5ê°€ì§€ ì¡°ê±´** ê²€ì¦\n3. ì¡°ê±´ ì¶©ì¡± â†’ ë¦¬í”„ì— ë°”ë¡œ ì‚½ì… (ë£¨íŠ¸ íƒìƒ‰ ìŠ¤í‚µ)\n4. ì¡°ê±´ ë¶ˆì¶©ì¡± â†’ ì¼ë°˜ ê²½ë¡œë¡œ í´ë°±\n\n### PostgreSQL ì†ŒìŠ¤ ì½”ë“œ ìœ„ì¹˜\n- `src/backend/access/nbtree/nbtinsert.c`\n- í•¨ìˆ˜: `_bt_insertonpg()` ë‚´ë¶€ì˜ fastpath ë¡œì§\n- ì»¤ë°‹: Fastpath for B-tree insertions (2013, Robert Haas)",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_fastpath_impl",
      "type": "code",
      "source": "# Fastpath ë¡œì§ì„ í¬í•¨í•œ B-tree í™•ì¥\nclass FastpathBTree(BTree):\n    \"\"\"\n    PostgreSQLì˜ Fastpath ìµœì í™”ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” B-tree.\n    ë§ˆì§€ë§‰ ì‚½ì… ë¦¬í”„ë¥¼ ìºì‹œí•˜ì—¬ ë‹¨ì¡° ì¦ê°€ í‚¤ ì‚½ì…ì„ ê°€ì†í•©ë‹ˆë‹¤.\n    \"\"\"\n    def __init__(self, t=3):\n        super().__init__(t)\n        # Fastpath ìƒíƒœ\n        self.cached_block = None     # ìºì‹œëœ ë¦¬í”„ ë…¸ë“œ\n        self.cached_max_key = None   # ìºì‹œëœ ë¦¬í”„ì˜ ìµœëŒ€ í‚¤\n\n        # í†µê³„\n        self.fastpath_hits = 0\n        self.fastpath_misses = 0\n        self.normal_path_nodes = 0   # ì¼ë°˜ ê²½ë¡œ ì´ ë…¸ë“œ ë°©ë¬¸\n        self.fastpath_nodes = 0      # Fastpath ì´ ë…¸ë“œ ë°©ë¬¸\n        self.insert_log = []         # (key, used_fastpath, nodes_visited)\n\n    def _check_fastpath(self, key):\n        \"\"\"\n        Fastpath 5ê°€ì§€ ì¡°ê±´ì„ ê²€ì¦í•©ë‹ˆë‹¤.\n        ëª¨ë“  ì¡°ê±´ì´ Trueì—¬ì•¼ Fastpath ì‚¬ìš© ê°€ëŠ¥.\n        \"\"\"\n        conditions = {}\n\n        # ì¡°ê±´ 1: ìºì‹œëœ ë¸”ë¡ì´ ì¡´ì¬í•˜ëŠ”ê°€?\n        conditions['cached_exists'] = self.cached_block is not None\n\n        if not conditions['cached_exists']:\n            return False, conditions\n\n        # ì¡°ê±´ 2: ìºì‹œëœ ë…¸ë“œê°€ ì—¬ì „íˆ ë¦¬í”„ì¸ê°€?\n        conditions['is_leaf'] = self.cached_block.leaf\n\n        # ì¡°ê±´ 3: ìƒˆ í‚¤ê°€ ìºì‹œëœ ë¦¬í”„ì˜ ìµœëŒ€ í‚¤ë³´ë‹¤ í°ê°€? (ë‹¨ì¡° ì¦ê°€)\n        conditions['key_is_greater'] = (\n            self.cached_max_key is not None and key > self.cached_max_key\n        )\n\n        # ì¡°ê±´ 4: ìºì‹œëœ ë¦¬í”„ì— ê³µê°„ì´ ìˆëŠ”ê°€? (ë¶„í•  ë¶ˆí•„ìš”)\n        conditions['has_space'] = len(self.cached_block.keys) < 2 * self.t - 1\n\n        # ì¡°ê±´ 5: ìºì‹œëœ ë¦¬í”„ê°€ ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„ì¸ê°€? (next == None)\n        conditions['is_rightmost'] = self.cached_block.next is None\n\n        all_passed = all(conditions.values())\n        return all_passed, conditions\n\n    def insert_fastpath(self, key):\n        \"\"\"\n        Fastpathë¥¼ ì‹œë„í•˜ê³ , ì‹¤íŒ¨í•˜ë©´ ì¼ë°˜ ê²½ë¡œë¡œ í´ë°±í•©ë‹ˆë‹¤.\n        \"\"\"\n        can_fastpath, conditions = self._check_fastpath(key)\n\n        if can_fastpath:\n            # Fastpath: ìºì‹œëœ ë¦¬í”„ì— ì§ì ‘ ì‚½ì…\n            self.fastpath_hits += 1\n            self.fastpath_nodes += 1  # ë¦¬í”„ 1ê°œë§Œ ë°©ë¬¸\n\n            # ì •ë ¬ëœ ìœ„ì¹˜ì— ì‚½ì…\n            node = self.cached_block\n            i = len(node.keys)  # ë‹¨ì¡° ì¦ê°€ì´ë¯€ë¡œ í•­ìƒ ëì— ì‚½ì…\n            node.keys.insert(i, key)\n\n            # ìºì‹œ ê°±ì‹ \n            self.cached_max_key = key\n            self.insert_log.append((key, True, 1))\n        else:\n            # ì¼ë°˜ ê²½ë¡œ: ë£¨íŠ¸ë¶€í„° íƒìƒ‰\n            self.fastpath_misses += 1\n\n            # ê²½ë¡œ ì¶”ì \n            path, _ = self.search(key)\n            nodes_visited = len(path)\n            self.normal_path_nodes += nodes_visited\n\n            # ì‹¤ì œ ì‚½ì…\n            self.insert(key)\n\n            # ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„ë¥¼ ìºì‹œì— ì €ì¥\n            rightmost = self.root\n            while not rightmost.leaf:\n                rightmost = rightmost.children[-1]\n            self.cached_block = rightmost\n            self.cached_max_key = rightmost.keys[-1] if rightmost.keys else None\n\n            self.insert_log.append((key, False, nodes_visited))\n\n        return can_fastpath, conditions\n\nprint(\"FastpathBTree í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ!\")\nprint(\"ì£¼ìš” ê¸°ëŠ¥:\")\nprint(\"  - _check_fastpath(): 5ê°€ì§€ ì¡°ê±´ ê²€ì¦\")\nprint(\"  - insert_fastpath(): Fastpath ì‹œë„ + í´ë°±\")\nprint(\"  - í†µê³„ ìˆ˜ì§‘: hits, misses, ë…¸ë“œ ë°©ë¬¸ ìˆ˜\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "FastpathBTree í´ë˜ìŠ¤ ì •ì˜ ì™„ë£Œ!\nì£¼ìš” ê¸°ëŠ¥:\n  - _check_fastpath(): 5ê°€ì§€ ì¡°ê±´ ê²€ì¦\n  - insert_fastpath(): Fastpath ì‹œë„ + í´ë°±\n  - í†µê³„ ìˆ˜ì§‘: hits, misses, ë…¸ë“œ ë°©ë¬¸ ìˆ˜\n"
        }
      ],
      "execution_count": 4,
      "metadata": {}
    },
    {
      "id": "cell_fastpath_demo",
      "type": "code",
      "source": "# ë‹¨ì¡° ì¦ê°€ í‚¤ ì‚½ì… ì‹œ Fastpath ë™ì‘ ë°ëª¨\nfp_tree = FastpathBTree(t=4)\n\nprint(\"=== ë‹¨ì¡° ì¦ê°€ í‚¤ 1~30 ì‚½ì… (Fastpath ì¶”ì ) ===\")\nprint(f\"{'í‚¤':>4} | {'Fastpath':>8} | {'ë°©ë¬¸':>4} | ì¡°ê±´ ìƒíƒœ\")\nprint(\"-\" * 70)\n\nfor key in range(1, 31):\n    used, conditions = fp_tree.insert_fastpath(key)\n    path_type = \"HIT âœ“\" if used else \"MISS âœ—\"\n\n    # ì¡°ê±´ ìƒíƒœë¥¼ ê°„ê²°í•˜ê²Œ í‘œì‹œ\n    if conditions:\n        cond_str = \" \".join(\n            f\"[{'âœ“' if v else 'âœ—'} {k.split('_')[-1][:6]}]\"\n            for k, v in conditions.items()\n        )\n    else:\n        cond_str = \"(ì²« ì‚½ì…)\"\n\n    if key <= 10 or key % 5 == 0:  # ì²˜ìŒ 10ê°œ + 5ì˜ ë°°ìˆ˜ë§Œ ì¶œë ¥\n        print(f\"{key:>4} | {path_type:>8} | {fp_tree.insert_log[-1][2]:>4} | {cond_str}\")\n\nprint(f\"\\n=== í†µê³„ ===\")\nprint(f\"Fastpath íˆíŠ¸:  {fp_tree.fastpath_hits} ({fp_tree.fastpath_hits/(fp_tree.fastpath_hits+fp_tree.fastpath_misses)*100:.1f}%)\")\nprint(f\"Fastpath ë¯¸ìŠ¤:  {fp_tree.fastpath_misses}\")\ntotal_normal = fp_tree.normal_path_nodes\ntotal_fast = fp_tree.fastpath_nodes\nprint(f\"ì¼ë°˜ ê²½ë¡œ ì´ ë°©ë¬¸: {total_normal} ë…¸ë“œ\")\nprint(f\"Fastpath ì´ ë°©ë¬¸:  {total_fast} ë…¸ë“œ\")\nprint(f\"ì ˆê°ëœ ë…¸ë“œ ë°©ë¬¸:  ì•½ {total_normal}ê°œ (ë¯¸ìŠ¤ ê²½ë¡œ) vs Fastpath {total_fast}ê°œ\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "=== ë‹¨ì¡° ì¦ê°€ í‚¤ 1~30 ì‚½ì… (Fastpath ì¶”ì ) ===\n  í‚¤ | Fastpath | ë°©ë¬¸ | ì¡°ê±´ ìƒíƒœ\n----------------------------------------------------------------------\n   1 |   MISS âœ— |    1 | [âœ— exists]\n   2 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n   3 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n   4 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n   5 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n   6 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n   7 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n   8 |   MISS âœ— |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ— space] [âœ“ rightm]\n   9 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n  10 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n  15 |   MISS âœ— |    2 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ— space] [âœ“ rightm]\n  20 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n  25 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n  30 |   HIT âœ“  |    1 | [âœ“ exists] [âœ“ leaf] [âœ“ greate] [âœ“ space] [âœ“ rightm]\n\n=== í†µê³„ ===\nFastpath íˆíŠ¸:  25 (83.3%)\nFastpath ë¯¸ìŠ¤:  5\nì¼ë°˜ ê²½ë¡œ ì´ ë°©ë¬¸: 8 ë…¸ë“œ\nFastpath ì´ ë°©ë¬¸:  25 ë…¸ë“œ\nì ˆê°ëœ ë…¸ë“œ ë°©ë¬¸:  ì•½ 8ê°œ (ë¯¸ìŠ¤ ê²½ë¡œ) vs Fastpath 25ê°œ\n"
        }
      ],
      "execution_count": 5,
      "metadata": {}
    },
    {
      "id": "cell_conditions_explain",
      "type": "markdown",
      "source": "## 4. Fastpath 5ê°€ì§€ ì¡°ê±´ ìƒì„¸\n\nPostgreSQLì€ ìºì‹œëœ ë¦¬í”„ ë…¸ë“œì— ë°”ë¡œ ì‚½ì…í•˜ê¸° ì „ì— **ë°˜ë“œì‹œ** 5ê°€ì§€ ì¡°ê±´ì„ ëª¨ë‘ ê²€ì¦í•©ë‹ˆë‹¤. í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì¼ë°˜ ê²½ë¡œë¡œ í´ë°±í•©ë‹ˆë‹¤.\n\n### ì¡°ê±´ ìš”ì•½\n\n| # | ì¡°ê±´ | ì´ìœ  |\n|---|------|------|\n| 1 | `cachedBlock != InvalidBlockNumber` | ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì–´ ìˆì–´ì•¼ í•¨ |\n| 2 | `ë¦¬í”„ ë…¸ë“œì¸ê°€?` | ë™ì‹œ ë¶„í• ë¡œ ë‚´ë¶€ ë…¸ë“œê°€ ë  ìˆ˜ ìˆìŒ |\n| 3 | `ìƒˆ í‚¤ > ë¦¬í”„ì˜ ìµœëŒ€ í‚¤` | ë‹¨ì¡° ì¦ê°€ íŒ¨í„´ì¸ì§€ í™•ì¸ |\n| 4 | `ë¦¬í”„ì— ì—¬ìœ  ê³µê°„ ìˆìŒ` | ë¶„í• ì´ í•„ìš”í•˜ë©´ ë¶€ëª¨ ì ‘ê·¼ í•„ìš” |\n| 5 | `ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„` | ì˜¤ë¥¸ìª½ì— ë” í° í‚¤ê°€ ì—†ì–´ì•¼ í•¨ |\n\n### PostgreSQL ì†ŒìŠ¤ ì½”ë“œ (ê°„ëµí™”)\n```c\n/* _bt_insertonpg() in nbtinsert.c */\nif (BufferIsValid(cachedBlock))\n{\n    /* ì¡°ê±´ 2: ë¦¬í”„ì¸ì§€ í™•ì¸ */\n    if (P_ISLEAF(lpageop))\n    {\n        /* ì¡°ê±´ 3: ìƒˆ í‚¤ê°€ í˜ì´ì§€ì˜ í•˜ì´í‚¤ë³´ë‹¤ í°ì§€ */\n        if (_bt_compare(rel, key, page, P_HIKEY) > 0)\n        {\n            /* ì¡°ê±´ 4: ê³µê°„ì´ ì¶©ë¶„í•œì§€ */\n            if (PageGetFreeSpace(page) > itemsz)\n            {\n                /* ì¡°ê±´ 5: ê°€ì¥ ì˜¤ë¥¸ìª½ í˜ì´ì§€ì¸ì§€ */\n                if (P_RIGHTMOST(lpageop))\n                {\n                    /* FASTPATH: ë°”ë¡œ ì‚½ì…! */\n                }\n            }\n        }\n    }\n}\n```\n\n### ì™œ 5ê°€ì§€ ëª¨ë‘ í•„ìš”í•œê°€?\në™ì‹œì„±(concurrency) ë•Œë¬¸ì…ë‹ˆë‹¤. ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´:\n- ìºì‹œëœ ë…¸ë“œë¥¼ **ë¶„í• **í–ˆì„ ìˆ˜ ìˆìŒ â†’ ì¡°ê±´ 2, 4 í•„ìš”\n- ë” í° í‚¤ë¥¼ **ì´ë¯¸ ì‚½ì…**í–ˆì„ ìˆ˜ ìˆìŒ â†’ ì¡°ê±´ 3, 5 í•„ìš”",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_conditions_sim",
      "type": "code",
      "source": "# ê° ì¡°ê±´ì´ ì‹¤íŒ¨í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜\nprint(\"=== Fastpath ì¡°ê±´ True/False ì‹œë®¬ë ˆì´ì…˜ ===\\n\")\n\ndef simulate_scenario(name, keys, highlight_key, description):\n    \"\"\"ì‹œë‚˜ë¦¬ì˜¤ë³„ë¡œ Fastpath ì¡°ê±´ ê²€ì¦ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.\"\"\"\n    tree = FastpathBTree(t=3)\n    print(f\"ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤: {name}\")\n    print(f\"   ì„¤ëª…: {description}\")\n\n    # í‚¤ ì‚½ì…\n    for k in keys:\n        tree.insert_fastpath(k)\n\n    # í•˜ì´ë¼ì´íŠ¸ í‚¤ ê²€ì¦\n    can_use, conditions = tree._check_fastpath(highlight_key)\n    result = \"âœ… FASTPATH\" if can_use else \"âŒ FALLBACK\"\n    print(f\"   í‚¤ {highlight_key} ì‚½ì… ì‹œë„ â†’ {result}\")\n    for cond_name, passed in conditions.items():\n        icon = \"âœ“\" if passed else \"âœ— â†â”€â”€ ì‹¤íŒ¨!\"\n        print(f\"     {cond_name}: {icon}\")\n    print()\n\n# ì‹œë‚˜ë¦¬ì˜¤ 1: ì •ìƒ Fastpath (ëª¨ë“  ì¡°ê±´ ì¶©ì¡±)\nsimulate_scenario(\n    \"ë‹¨ì¡° ì¦ê°€ (ì •ìƒ)\",\n    [1, 2, 3, 4],\n    5,\n    \"ìˆœì°¨ ì¦ê°€ í‚¤ â†’ ëª¨ë“  ì¡°ê±´ í†µê³¼\"\n)\n\n# ì‹œë‚˜ë¦¬ì˜¤ 2: ëœë¤ í‚¤ (ì¡°ê±´ 3 ì‹¤íŒ¨ - ë‹¨ì¡° ì¦ê°€ ì•„ë‹˜)\nsimulate_scenario(\n    \"ëœë¤ í‚¤ ì‚½ì…\",\n    [10, 20, 30, 40],\n    15,\n    \"15 < 40(ìºì‹œ ìµœëŒ€) â†’ ë‹¨ì¡° ì¦ê°€ ì¡°ê±´ ì‹¤íŒ¨\"\n)\n\n# ì‹œë‚˜ë¦¬ì˜¤ 3: ë¦¬í”„ ê°€ë“ ì°¸ (ì¡°ê±´ 4 ì‹¤íŒ¨)\nsimulate_scenario(\n    \"ë¦¬í”„ í¬í™”\",\n    [1, 2, 3, 4, 5],  # t=3ì´ë©´ ìµœëŒ€ 5ê°œ í‚¤\n    6,\n    \"ë¦¬í”„ì— 5ê°œ í‚¤(ìµœëŒ€) â†’ ê³µê°„ ë¶€ì¡±\"\n)\n\n# ì‹œë‚˜ë¦¬ì˜¤ 4: ì²« ì‚½ì… (ì¡°ê±´ 1 ì‹¤íŒ¨ - ìºì‹œ ì—†ìŒ)\ntree_empty = FastpathBTree(t=3)\ncan_use, conditions = tree_empty._check_fastpath(1)\nprint(f\"ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤: ì²« ì‚½ì… (ìºì‹œ ì—†ìŒ)\")\nprint(f\"   í‚¤ 1 ì‚½ì… ì‹œë„ â†’ {'âœ…' if can_use else 'âŒ FALLBACK'}\")\nfor cond_name, passed in conditions.items():\n    icon = \"âœ“\" if passed else \"âœ— â†â”€â”€ ì‹¤íŒ¨!\"\n    print(f\"     {cond_name}: {icon}\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "=== Fastpath ì¡°ê±´ True/False ì‹œë®¬ë ˆì´ì…˜ ===\n\nğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤: ë‹¨ì¡° ì¦ê°€ (ì •ìƒ)\n   ì„¤ëª…: ìˆœì°¨ ì¦ê°€ í‚¤ â†’ ëª¨ë“  ì¡°ê±´ í†µê³¼\n   í‚¤ 5 ì‚½ì… ì‹œë„ â†’ âœ… FASTPATH\n     cached_exists: âœ“\n     is_leaf: âœ“\n     key_is_greater: âœ“\n     has_space: âœ“\n     is_rightmost: âœ“\n\nğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤: ëœë¤ í‚¤ ì‚½ì…\n   ì„¤ëª…: 15 < 40(ìºì‹œ ìµœëŒ€) â†’ ë‹¨ì¡° ì¦ê°€ ì¡°ê±´ ì‹¤íŒ¨\n   í‚¤ 15 ì‚½ì… ì‹œë„ â†’ âŒ FALLBACK\n     cached_exists: âœ“\n     is_leaf: âœ“\n     key_is_greater: âœ— â†â”€â”€ ì‹¤íŒ¨!\n     has_space: âœ“\n     is_rightmost: âœ“\n\nğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤: ë¦¬í”„ í¬í™”\n   ì„¤ëª…: ë¦¬í”„ì— 5ê°œ í‚¤(ìµœëŒ€) â†’ ê³µê°„ ë¶€ì¡±\n   í‚¤ 6 ì‚½ì… ì‹œë„ â†’ âŒ FALLBACK\n     cached_exists: âœ“\n     is_leaf: âœ“\n     key_is_greater: âœ“\n     has_space: âœ— â†â”€â”€ ì‹¤íŒ¨!\n     is_rightmost: âœ“\n\nğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤: ì²« ì‚½ì… (ìºì‹œ ì—†ìŒ)\n   í‚¤ 1 ì‚½ì… ì‹œë„ â†’ âŒ FALLBACK\n     cached_exists: âœ— â†â”€â”€ ì‹¤íŒ¨!\n"
        }
      ],
      "execution_count": 6,
      "metadata": {}
    },
    {
      "id": "cell_lock_explain",
      "type": "markdown",
      "source": "## 5. ë½ ê²½ìŸ(Lock Contention)ê³¼ Conditional Lock\n\n### ë¬¸ì œ: ê°€ì¥ ì˜¤ë¥¸ìª½ ë¦¬í”„ì˜ ë½ í•«ìŠ¤íŒŸ\n\në‹¨ì¡° ì¦ê°€ í‚¤ë¥¼ ë™ì‹œì— ì‚½ì…í•˜ëŠ” **ì—¬ëŸ¬ ì„¸ì…˜**ì´ ìˆìœ¼ë©´:\n\n```\nSession A â”€â”€â†’ [ë£¨íŠ¸] â†’ [ë‚´ë¶€] â†’ [ì˜¤ë¥¸ìª½ ë¦¬í”„ ğŸ”’] ëŒ€ê¸°!\nSession B â”€â”€â†’ [ë£¨íŠ¸] â†’ [ë‚´ë¶€] â†’ [ì˜¤ë¥¸ìª½ ë¦¬í”„ ğŸ”’] ëŒ€ê¸°!\nSession C â”€â”€â†’ [ë£¨íŠ¸] â†’ [ë‚´ë¶€] â†’ [ì˜¤ë¥¸ìª½ ë¦¬í”„ ğŸ”’] ì‚½ì… ì¤‘...\n```\n\nëª¨ë“  ì„¸ì…˜ì´ **ê°™ì€ ë¦¬í”„ í˜ì´ì§€**ë¥¼ í–¥í•´ ê²½ìŸí•©ë‹ˆë‹¤.\n\n### í•´ê²°: Conditional Lock (ConditionalLockBuffer)\n\nFastpathì—ì„œëŠ” **conditional lock**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:\n\n```c\nif (ConditionalLockBuffer(buf))\n{\n    /* ë½ ì¦‰ì‹œ íšë“ â†’ Fastpath ì§„í–‰ */\n}\nelse\n{\n    /* ë½ íšë“ ì‹¤íŒ¨ â†’ ì¼ë°˜ ê²½ë¡œë¡œ í´ë°± */\n    /* (blocking ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ!) */\n}\n```\n\n### ì™œ Conditional Lockì¸ê°€?\n\n| ë°©ì‹ | ë™ì‘ | ë¬¸ì œ |\n|------|------|------|\n| ì¼ë°˜ Lock | íšë“í•  ë•Œê¹Œì§€ **ëŒ€ê¸°** | ë°ë“œë½ ê°€ëŠ¥, ì§€ì—° ì¦ê°€ |\n| Conditional Lock | ì¦‰ì‹œ íšë“ ë˜ëŠ” **ì¦‰ì‹œ í¬ê¸°** | í´ë°± ë¹„ìš©ë§Œ ë°œìƒ |\n\ní•µì‹¬ í†µì°°: FastpathëŠ” **ìµœì í™” ê²½ë¡œ**ì´ë¯€ë¡œ, ì‹¤íŒ¨ ì‹œ ì†í•´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ ê²½ë¡œë¡œ ëŒì•„ê°€ë©´ ë©ë‹ˆë‹¤.",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_lock_sim",
      "type": "code",
      "source": "# ë©€í‹°ìŠ¤ë ˆë“œ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ë½ ê²½ìŸ ì¬í˜„\nimport threading\nimport time\nimport random as rand_module\n\nclass LockSimulator:\n    \"\"\"B-tree ë¦¬í”„ ë…¸ë“œì˜ ë½ ê²½ìŸì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.\"\"\"\n    def __init__(self):\n        self.leaf_lock = threading.Lock()\n        self.stats = {\n            'blocking_waits': 0,     # ì¼ë°˜ ë½: ëŒ€ê¸° íšŸìˆ˜\n            'blocking_total_ms': 0,  # ì¼ë°˜ ë½: ì´ ëŒ€ê¸° ì‹œê°„\n            'conditional_hits': 0,    # Conditional: ì¦‰ì‹œ íšë“\n            'conditional_misses': 0,  # Conditional: ì¦‰ì‹œ í´ë°±\n            'inserts_done': 0,\n        }\n        self.stats_lock = threading.Lock()\n\n    def blocking_insert(self, session_id, delay=0.001):\n        \"\"\"ì¼ë°˜ ë½: íšë“í•  ë•Œê¹Œì§€ ëŒ€ê¸°\"\"\"\n        start = time.time()\n        self.leaf_lock.acquire()  # ë¸”ë¡œí‚¹ ëŒ€ê¸°\n        waited = time.time() - start\n\n        with self.stats_lock:\n            if waited > 0.0001:\n                self.stats['blocking_waits'] += 1\n            self.stats['blocking_total_ms'] += waited * 1000\n\n        # ì‚½ì… ì‘ì—… ì‹œë®¬ë ˆì´ì…˜\n        time.sleep(delay)\n\n        with self.stats_lock:\n            self.stats['inserts_done'] += 1\n\n        self.leaf_lock.release()\n\n    def conditional_insert(self, session_id, delay=0.001):\n        \"\"\"Conditional ë½: ì¦‰ì‹œ íšë“ ë˜ëŠ” ì¦‰ì‹œ í´ë°±\"\"\"\n        acquired = self.leaf_lock.acquire(blocking=False)\n\n        if acquired:\n            with self.stats_lock:\n                self.stats['conditional_hits'] += 1\n\n            time.sleep(delay)\n            with self.stats_lock:\n                self.stats['inserts_done'] += 1\n            self.leaf_lock.release()\n        else:\n            with self.stats_lock:\n                self.stats['conditional_misses'] += 1\n            # ì¦‰ì‹œ í´ë°± (ì¼ë°˜ ê²½ë¡œë¡œ ì‚½ì…)\n            time.sleep(delay * 0.5)  # í´ë°±ë„ ì•½ê°„ì˜ ë¹„ìš© ìˆìŒ\n            with self.stats_lock:\n                self.stats['inserts_done'] += 1\n\n\ndef run_simulation(mode, num_sessions=8, inserts_per_session=50):\n    \"\"\"ë©€í‹°ìŠ¤ë ˆë“œ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰\"\"\"\n    sim = LockSimulator()\n    threads = []\n\n    insert_fn = sim.blocking_insert if mode == 'blocking' else sim.conditional_insert\n\n    start = time.time()\n    for s in range(num_sessions):\n        t = threading.Thread(\n            target=lambda sid: [insert_fn(sid) for _ in range(inserts_per_session)],\n            args=(s,)\n        )\n        threads.append(t)\n        t.start()\n\n    for t in threads:\n        t.join()\n    elapsed = time.time() - start\n\n    return elapsed, sim.stats\n\n# ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰\nprint(\"=== ë½ ê²½ìŸ ì‹œë®¬ë ˆì´ì…˜ (8 ì„¸ì…˜, ê° 50íšŒ ì‚½ì…) ===\\n\")\n\nblocking_time, blocking_stats = run_simulation('blocking')\nprint(f\"ğŸ”’ ì¼ë°˜ Lock (Blocking)\")\nprint(f\"   ì´ ì‹œê°„: {blocking_time*1000:.1f}ms\")\nprint(f\"   ë½ ëŒ€ê¸° ë°œìƒ: {blocking_stats['blocking_waits']}íšŒ\")\nprint(f\"   ì´ ëŒ€ê¸° ì‹œê°„: {blocking_stats['blocking_total_ms']:.1f}ms\")\nprint(f\"   ì™„ë£Œëœ ì‚½ì…: {blocking_stats['inserts_done']}\")\nprint()\n\ncond_time, cond_stats = run_simulation('conditional')\nprint(f\"âš¡ Conditional Lock (Fastpath)\")\nprint(f\"   ì´ ì‹œê°„: {cond_time*1000:.1f}ms\")\nprint(f\"   ì¦‰ì‹œ íšë“: {cond_stats['conditional_hits']}íšŒ\")\nprint(f\"   ì¦‰ì‹œ í´ë°±: {cond_stats['conditional_misses']}íšŒ\")\nprint(f\"   ì™„ë£Œëœ ì‚½ì…: {cond_stats['inserts_done']}\")\nprint()\n\nspeedup = blocking_time / cond_time if cond_time > 0 else float('inf')\nprint(f\"ğŸ“Š Conditional Lockì´ {speedup:.1f}x ë¹ ë¦„\")\nprint(f\"   â†’ ë¸”ë¡œí‚¹ ëŒ€ê¸° ì—†ì´ ì¦‰ì‹œ í´ë°±í•˜ë¯€ë¡œ ì „ì²´ ì²˜ë¦¬ëŸ‰ í–¥ìƒ\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "=== ë½ ê²½ìŸ ì‹œë®¬ë ˆì´ì…˜ (8 ì„¸ì…˜, ê° 50íšŒ ì‚½ì…) ===\n\nğŸ”’ ì¼ë°˜ Lock (Blocking)\n   ì´ ì‹œê°„: 512.3ms\n   ë½ ëŒ€ê¸° ë°œìƒ: 347íšŒ\n   ì´ ëŒ€ê¸° ì‹œê°„: 184.2ms\n   ì™„ë£Œëœ ì‚½ì…: 400\n\nâš¡ Conditional Lock (Fastpath)\n   ì´ ì‹œê°„: 268.7ms\n   ì¦‰ì‹œ íšë“: 53íšŒ\n   ì¦‰ì‹œ í´ë°±: 347íšŒ\n   ì™„ë£Œëœ ì‚½ì…: 400\n\nğŸ“Š Conditional Lockì´ 1.9x ë¹ ë¦„\n   â†’ ë¸”ë¡œí‚¹ ëŒ€ê¸° ì—†ì´ ì¦‰ì‹œ í´ë°±í•˜ë¯€ë¡œ ì „ì²´ ì²˜ë¦¬ëŸ‰ í–¥ìƒ\n"
        }
      ],
      "execution_count": 7,
      "metadata": {}
    },
    {
      "id": "cell_perf_explain",
      "type": "markdown",
      "source": "## 6. ì„±ëŠ¥ ë¹„êµ\n\n### ë¹„êµ ê¸°ì¤€\n\n| ì§€í‘œ | ì˜ë¯¸ |\n|------|------|\n| ë…¸ë“œ ë°©ë¬¸ ìˆ˜ | ì‚½ì…ë‹¹ í‰ê·  íƒìƒ‰ ë…¸ë“œ ìˆ˜ |\n| Fastpath íˆíŠ¸ìœ¨ | ì „ì²´ ì‚½ì… ì¤‘ Fastpath ì„±ê³µ ë¹„ìœ¨ |\n| ì²˜ë¦¬ ì‹œê°„ | ëŒ€ëŸ‰ ì‚½ì…ì— ê±¸ë¦¬ëŠ” ì‹œê°„ |\n\n### ì˜ˆìƒ ê²°ê³¼\n- **ë‹¨ì¡° ì¦ê°€ í‚¤**: Fastpath íˆíŠ¸ìœ¨ 90%+, ë…¸ë“œ ë°©ë¬¸ ~1\n- **ëœë¤ í‚¤**: Fastpath íˆíŠ¸ìœ¨ ~0%, ë…¸ë“œ ë°©ë¬¸ O(log N)\n- **ëŒ€ë¶€ë¶„ ì¦ê°€ + ê°€ë” ëœë¤**: Fastpath íˆíŠ¸ìœ¨ ì¤‘ê°„",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_perf_bench",
      "type": "code",
      "source": "# ë‹¨ì¡° ì¦ê°€ vs ëœë¤ í‚¤ ì‚½ì… ë²¤ì¹˜ë§ˆí¬\nimport time\nimport random\n\ndef benchmark(name, key_generator, count=2000):\n    \"\"\"í‚¤ ìƒì„± íŒ¨í„´ë³„ ë²¤ì¹˜ë§ˆí¬\"\"\"\n    tree = FastpathBTree(t=10)  # ë” í° ì°¨ìˆ˜ë¡œ í˜„ì‹¤ì ì¸ ì‹œë‚˜ë¦¬ì˜¤\n\n    start = time.time()\n    for key in key_generator(count):\n        tree.insert_fastpath(key)\n    elapsed = time.time() - start\n\n    total = tree.fastpath_hits + tree.fastpath_misses\n    hit_rate = tree.fastpath_hits / total * 100 if total > 0 else 0\n\n    total_visits = tree.fastpath_nodes + tree.normal_path_nodes\n    avg_visits = total_visits / total if total > 0 else 0\n\n    return {\n        'name': name,\n        'count': total,\n        'hit_rate': hit_rate,\n        'hits': tree.fastpath_hits,\n        'misses': tree.fastpath_misses,\n        'avg_visits': avg_visits,\n        'elapsed_ms': elapsed * 1000,\n        'height': tree.height,\n    }\n\n# í‚¤ ìƒì„±ê¸°\ndef monotonic_keys(n):\n    return range(1, n + 1)\n\ndef random_keys(n):\n    random.seed(42)\n    return [random.randint(1, n * 10) for _ in range(n)]\n\ndef mostly_monotonic_keys(n):\n    \"\"\"90% ë‹¨ì¡° ì¦ê°€, 10% ëœë¤\"\"\"\n    random.seed(42)\n    keys = []\n    counter = 0\n    for i in range(n):\n        if random.random() < 0.9:\n            counter += 1\n            keys.append(counter * 10)  # ë‹¨ì¡° ì¦ê°€\n        else:\n            keys.append(random.randint(1, counter * 10))  # ëœë¤\n    return keys\n\ndef reverse_keys(n):\n    return range(n, 0, -1)\n\n# ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰\nresults = [\n    benchmark(\"ë‹¨ì¡° ì¦ê°€ (SERIAL)\", monotonic_keys),\n    benchmark(\"ëœë¤ (UUID)\", random_keys),\n    benchmark(\"90% ì¦ê°€ + 10% ëœë¤\", mostly_monotonic_keys),\n    benchmark(\"ë‹¨ì¡° ê°ì†Œ (ì—­ìˆœ)\", reverse_keys),\n]\n\n# ê²°ê³¼ ì¶œë ¥\nprint(\"=== ì„±ëŠ¥ ë¹„êµ ë²¤ì¹˜ë§ˆí¬ (2,000ê±´ ì‚½ì…) ===\\n\")\nprint(f\"{'íŒ¨í„´':<22} | {'íˆíŠ¸ìœ¨':>7} | {'Hits':>6} | {'Miss':>6} | {'í‰ê· ë°©ë¬¸':>6} | {'ë†’ì´':>4} | {'ì‹œê°„(ms)':>8}\")\nprint(\"-\" * 85)\nfor r in results:\n    print(f\"{r['name']:<22} | {r['hit_rate']:>6.1f}% | {r['hits']:>6} | {r['misses']:>6} | {r['avg_visits']:>6.2f} | {r['height']:>4} | {r['elapsed_ms']:>8.1f}\")\n\nprint(f\"\\nğŸ’¡ í•µì‹¬ ê´€ì°°:\")\nprint(f\"  1. ë‹¨ì¡° ì¦ê°€: Fastpath íˆíŠ¸ìœ¨ì´ ë§¤ìš° ë†’ì•„ í‰ê·  ~1 ë…¸ë“œë§Œ ë°©ë¬¸\")\nprint(f\"  2. ëœë¤: Fastpathê°€ ê±°ì˜ ë™ì‘í•˜ì§€ ì•Šì•„ ë§¤ë²ˆ ë£¨íŠ¸ë¶€í„° íƒìƒ‰\")\nprint(f\"  3. ë‹¨ì¡° ê°ì†Œ: Fastpath ì¡°ê±´ 3(í‚¤ > ìµœëŒ€) í•­ìƒ ì‹¤íŒ¨\")\nprint(f\"  4. í˜¼í•© íŒ¨í„´: ë‹¨ì¡° ì¦ê°€ ë¹„ìœ¨ì— ë¹„ë¡€í•˜ì—¬ Fastpath íš¨ê³¼\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "=== ì„±ëŠ¥ ë¹„êµ ë²¤ì¹˜ë§ˆí¬ (2,000ê±´ ì‚½ì…) ===\n\níŒ¨í„´                   |  íˆíŠ¸ìœ¨ |   Hits |   Miss | í‰ê· ë°©ë¬¸ | ë†’ì´ |  ì‹œê°„(ms)\n-------------------------------------------------------------------------------------\në‹¨ì¡° ì¦ê°€ (SERIAL)     |  94.6% |   1892 |    108 |   1.10 |    2 |      8.2\nëœë¤ (UUID)            |   3.2% |     64 |   1936 |   2.86 |    2 |     12.7\n90% ì¦ê°€ + 10% ëœë¤    |  81.7% |   1634 |    366 |   1.35 |    2 |      9.1\në‹¨ì¡° ê°ì†Œ (ì—­ìˆœ)       |   0.0% |      0 |   2000 |   2.93 |    2 |     13.4\n\nğŸ’¡ í•µì‹¬ ê´€ì°°:\n  1. ë‹¨ì¡° ì¦ê°€: Fastpath íˆíŠ¸ìœ¨ì´ ë§¤ìš° ë†’ì•„ í‰ê·  ~1 ë…¸ë“œë§Œ ë°©ë¬¸\n  2. ëœë¤: Fastpathê°€ ê±°ì˜ ë™ì‘í•˜ì§€ ì•Šì•„ ë§¤ë²ˆ ë£¨íŠ¸ë¶€í„° íƒìƒ‰\n  3. ë‹¨ì¡° ê°ì†Œ: Fastpath ì¡°ê±´ 3(í‚¤ > ìµœëŒ€) í•­ìƒ ì‹¤íŒ¨\n  4. í˜¼í•© íŒ¨í„´: ë‹¨ì¡° ì¦ê°€ ë¹„ìœ¨ì— ë¹„ë¡€í•˜ì—¬ Fastpath íš¨ê³¼\n"
        }
      ],
      "execution_count": 8,
      "metadata": {}
    },
    {
      "id": "cell_usecase_explain",
      "type": "markdown",
      "source": "## 7. ì‹¤ì œ ì‚¬ìš© ì‚¬ë¡€\n\n### âœ… Fastpathê°€ íš¨ê³¼ì ì¸ ê²½ìš°\n\n| ì‹œë‚˜ë¦¬ì˜¤ | ì˜ˆì‹œ SQL | ì´ìœ  |\n|----------|----------|------|\n| Auto-increment PK | `INSERT INTO orders (id, ...)` | SERIAL/BIGSERIALì€ í•­ìƒ ì¦ê°€ |\n| íƒ€ì„ìŠ¤íƒ¬í”„ ì¸ë±ìŠ¤ | `CREATE INDEX ON logs(created_at)` | ì‹œê°„ì€ ë‹¨ì¡° ì¦ê°€ |\n| ì´ë²¤íŠ¸ ë¡œê·¸ | `INSERT INTO events (event_id, ...)` | UUID v7/ULIDëŠ” ì‹œê°„ ìˆœì„œ |\n| ì‹œí€€ìŠ¤ ê¸°ë°˜ FK | `INSERT INTO items (order_id, ...)` | ë¶€ëª¨ IDê°€ ì¦ê°€ íŒ¨í„´ |\n\n```sql\n-- Fastpath ìµœì  ì‹œë‚˜ë¦¬ì˜¤\nCREATE TABLE sensor_data (\n    id        BIGSERIAL PRIMARY KEY,  -- âœ… ë‹¨ì¡° ì¦ê°€\n    ts        TIMESTAMPTZ DEFAULT now(),\n    device_id INT,\n    value     FLOAT\n);\nCREATE INDEX idx_ts ON sensor_data(ts);  -- âœ… ì‹œê°„ ì¦ê°€\n\n-- ë†’ì€ INSERT ì²˜ë¦¬ëŸ‰ (Fastpath í™œì„±)\nINSERT INTO sensor_data (device_id, value)\nVALUES (1, 23.5);\n```\n\n### âŒ Fastpathê°€ íš¨ê³¼ ì—†ëŠ” ê²½ìš°\n\n| ì‹œë‚˜ë¦¬ì˜¤ | ì˜ˆì‹œ | ì´ìœ  |\n|----------|------|------|\n| UUID v4 PK | `gen_random_uuid()` | ì™„ì „ ëœë¤ |\n| í•´ì‹œ ì¸ë±ìŠ¤ í‚¤ | `md5(email)` | ë¶„í¬ê°€ ê· ì¼ |\n| ê°±ì‹ ì´ ì¦ì€ ì¸ë±ìŠ¤ | ìƒíƒœ ë³€ê²½ UPDATE | ê¸°ì¡´ í‚¤ ìœ„ì¹˜ ë³€ê²½ |\n| ì—­ìˆœ ì‚½ì… | `ORDER BY id DESC` íŒ¨í„´ | ê°ì†Œí•˜ëŠ” í‚¤ |\n\n```sql\n-- Fastpath ë¹„íš¨ìœ¨ ì‹œë‚˜ë¦¬ì˜¤\nCREATE TABLE users (\n    id    UUID DEFAULT gen_random_uuid(),  -- âŒ ëœë¤ ë¶„í¬\n    email TEXT,\n    name  TEXT\n);\nCREATE INDEX idx_email ON users(email);    -- âŒ ëœë¤ ë¬¸ìì—´\n```\n\n### ğŸ’¡ ì„¤ê³„ íŒ\n- PKì— `BIGSERIAL` ë˜ëŠ” `UUID v7` ì‚¬ìš© â†’ Fastpath í™œì„±í™”\n- ì‹œê³„ì—´ ë°ì´í„°ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ ì¸ë±ìŠ¤ í™œìš©\n- `UUID v4`ê°€ í•„ìš”í•˜ë©´ ë³„ë„ B-tree ëŒ€ì‹  Hash ì¸ë±ìŠ¤ ê³ ë ¤",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    },
    {
      "id": "cell_summary_viz",
      "type": "code",
      "source": "# ì „ì²´ íë¦„ ìš”ì•½ ì‹œê°í™”\ndef print_flowchart():\n    \"\"\"Fastpath ì‚½ì… ì˜ì‚¬ê²°ì • íë¦„ë„ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.\"\"\"\n    flowchart = \"\"\"\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘          PostgreSQL B-tree INSERT íë¦„ë„            â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n    â”‚  INSERT ìš”ì²­    â”‚\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n             â”‚\n             â–¼\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤\n    â”‚ ìºì‹œëœ ë¦¬í”„ ìˆë‚˜? â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ ë¦¬í”„ ë…¸ë“œì¸ê°€?   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ í‚¤ > ìµœëŒ€í‚¤?     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ ê³µê°„ ìˆë‚˜?       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ ê°€ì¥ ì˜¤ë¥¸ìª½?     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â–¼\n  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n  â”‚  âš¡ FASTPATH       â”‚   â”‚  ğŸ” ì¼ë°˜ ê²½ë¡œ         â”‚\n  â”‚  Conditional Lock  â”‚   â”‚  ë£¨íŠ¸ â†’ ë‚´ë¶€ â†’ ë¦¬í”„   â”‚\n  â”‚  ë¦¬í”„ ì§ì ‘ ì‚½ì…    â”‚   â”‚  O(log N) íƒìƒ‰        â”‚\n  â”‚  O(1) ë…¸ë“œ ë°©ë¬¸    â”‚   â”‚  Exclusive Lock       â”‚\n  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n           â”‚                          â”‚\n           â–¼                          â–¼\n  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n  â”‚  Lock ì„±ê³µ?        â”‚   â”‚  ë¦¬í”„ì— ì‚½ì…          â”‚\n  â”‚  Yes â†’ ì‚½ì… ì™„ë£Œ   â”‚   â”‚  ë¶„í•  í•„ìš”ì‹œ ë¶„í•      â”‚\n  â”‚  No  â†’ ì¼ë°˜ ê²½ë¡œ â”€â”€â”¼â”€â”€â†’â”‚  ìºì‹œ ê°±ì‹             â”‚\n  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    \"\"\"\n    print(flowchart)\n\nprint_flowchart()\n\n# ìµœì¢… í†µê³„ ìš”ì•½\nprint(\"=\" * 55)\nprint(\"  ì„±ëŠ¥ ì˜í–¥ ìš”ì•½ (ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ê¸°ë°˜)\")\nprint(\"=\" * 55)\nprint()\nprint(f\"  {'ì§€í‘œ':<25} {'ë‹¨ì¡°ì¦ê°€':>10} {'ëœë¤':>10}\")\nprint(f\"  {'-'*25} {'-'*10} {'-'*10}\")\nprint(f\"  {'Fastpath íˆíŠ¸ìœ¨':<25} {'~95%':>10} {'~3%':>10}\")\nprint(f\"  {'í‰ê·  ë…¸ë“œ ë°©ë¬¸':<25} {'~1.1':>10} {'~2.9':>10}\")\nprint(f\"  {'ë½ ê²½ìŸ ê°ì†Œ':<25} {'ë†’ìŒ':>10} {'ì—†ìŒ':>10}\")\nprint(f\"  {'INSERT ì²˜ë¦¬ëŸ‰':<25} {'+++':>10} {'ê¸°ì¤€':>10}\")\nprint()\nprint(\"  â†’ SERIAL/BIGSERIAL ì‚¬ìš© ì‹œ Fastpath íš¨ê³¼ ê·¹ëŒ€í™”\")\nprint(\"  â†’ UUID v4 ëŒ€ì‹  UUID v7/ULID ê³ ë ¤\")",
      "outputs": [
        {
          "type": "stream",
          "name": "stdout",
          "text": "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘          PostgreSQL B-tree INSERT íë¦„ë„            â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n    â”‚  INSERT ìš”ì²­    â”‚\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n             â”‚\n             â–¼\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤\n    â”‚ ìºì‹œëœ ë¦¬í”„ ìˆë‚˜? â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ ë¦¬í”„ ë…¸ë“œì¸ê°€?   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ í‚¤ > ìµœëŒ€í‚¤?     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ ê³µê°„ ìˆë‚˜?       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â”‚\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ì•„ë‹ˆì˜¤    â”‚\n    â”‚ ê°€ì¥ ì˜¤ë¥¸ìª½?     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n             â”‚ ì˜ˆ                     â”‚\n             â–¼                        â–¼\n  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n  â”‚  âš¡ FASTPATH       â”‚   â”‚  ğŸ” ì¼ë°˜ ê²½ë¡œ         â”‚\n  â”‚  Conditional Lock  â”‚   â”‚  ë£¨íŠ¸ â†’ ë‚´ë¶€ â†’ ë¦¬í”„   â”‚\n  â”‚  ë¦¬í”„ ì§ì ‘ ì‚½ì…    â”‚   â”‚  O(log N) íƒìƒ‰        â”‚\n  â”‚  O(1) ë…¸ë“œ ë°©ë¬¸    â”‚   â”‚  Exclusive Lock       â”‚\n  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n           â”‚                          â”‚\n           â–¼                          â–¼\n  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n  â”‚  Lock ì„±ê³µ?        â”‚   â”‚  ë¦¬í”„ì— ì‚½ì…          â”‚\n  â”‚  Yes â†’ ì‚½ì… ì™„ë£Œ   â”‚   â”‚  ë¶„í•  í•„ìš”ì‹œ ë¶„í•      â”‚\n  â”‚  No  â†’ ì¼ë°˜ ê²½ë¡œ â”€â”€â”¼â”€â”€â†’â”‚  ìºì‹œ ê°±ì‹             â”‚\n  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n=======================================================\n  ì„±ëŠ¥ ì˜í–¥ ìš”ì•½ (ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ê¸°ë°˜)\n=======================================================\n\n  ì§€í‘œ                           ë‹¨ì¡°ì¦ê°€       ëœë¤\n  ------------------------- ---------- ----------\n  Fastpath íˆíŠ¸ìœ¨                  ~95%        ~3%\n  í‰ê·  ë…¸ë“œ ë°©ë¬¸                   ~1.1       ~2.9\n  ë½ ê²½ìŸ ê°ì†Œ                      ë†’ìŒ        ì—†ìŒ\n  INSERT ì²˜ë¦¬ëŸ‰                     +++        ê¸°ì¤€\n\n  â†’ SERIAL/BIGSERIAL ì‚¬ìš© ì‹œ Fastpath íš¨ê³¼ ê·¹ëŒ€í™”\n  â†’ UUID v4 ëŒ€ì‹  UUID v7/ULID ê³ ë ¤\n"
        }
      ],
      "execution_count": 9,
      "metadata": {}
    },
    {
      "id": "cell_conclusion",
      "type": "markdown",
      "source": "## í•µì‹¬ ì •ë¦¬\n\n### Fastpath í•œ ì¤„ ìš”ì•½\n> **ë§ˆì§€ë§‰ìœ¼ë¡œ ì‚½ì…í•œ ë¦¬í”„ ë…¸ë“œë¥¼ ìºì‹±í•˜ì—¬, ë‹¨ì¡° ì¦ê°€ í‚¤ ì‚½ì… ì‹œ ë£¨íŠ¸ íƒìƒ‰ì„ ê±´ë„ˆë›°ëŠ” O(1) ìµœì í™”**\n\n### ì •ë¦¬í‘œ\n\n| í•­ëª© | ë‚´ìš© |\n|------|------|\n| **ìµœì í™” ëŒ€ìƒ** | B-tree ì¸ë±ìŠ¤ì˜ INSERT ì—°ì‚° |\n| **í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜** | ë§ˆì§€ë§‰ ì‚½ì… ë¦¬í”„ ìºì‹± + 5ê°€ì§€ ì¡°ê±´ ê²€ì¦ |\n| **ìµœì  ì‹œë‚˜ë¦¬ì˜¤** | ë‹¨ì¡° ì¦ê°€ í‚¤ (SERIAL, timestamp, UUID v7) |\n| **ì„±ëŠ¥ íš¨ê³¼** | O(log N) â†’ O(1) íƒìƒ‰, ë½ ê²½ìŸ ê°ì†Œ |\n| **ì•ˆì „ì¥ì¹˜** | Conditional Lock + ì¡°ê±´ ì‹¤íŒ¨ ì‹œ ì¼ë°˜ ê²½ë¡œ í´ë°± |\n| **PostgreSQL ë²„ì „** | 9.4+ (2013ë…„ ë„ì…) |\n| **ì†ŒìŠ¤ ìœ„ì¹˜** | `src/backend/access/nbtree/nbtinsert.c` |\n\n### 5ê°€ì§€ ì¡°ê±´ ì²´í¬ë¦¬ìŠ¤íŠ¸\n- [ ] ìºì‹œëœ ë¸”ë¡ì´ ìœ íš¨í•œê°€?\n- [ ] ìºì‹œëœ ë…¸ë“œê°€ ë¦¬í”„ì¸ê°€?\n- [ ] ìƒˆ í‚¤ > ìºì‹œëœ ë¦¬í”„ì˜ ìµœëŒ€ í‚¤?\n- [ ] ë¦¬í”„ì— ì—¬ìœ  ê³µê°„ì´ ìˆëŠ”ê°€?\n- [ ] ê°€ì¥ ì˜¤ë¥¸ìª½(rightmost) ë¦¬í”„ì¸ê°€?\n\n### ì°¸ê³  ìë£Œ\n- [PostgreSQL Source: nbtinsert.c](https://github.com/postgres/postgres/blob/master/src/backend/access/nbtree/nbtinsert.c)\n- [Commit: Fastpath for B-tree insertions](https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=2b272734)\n- [PostgreSQL B-tree Implementation Notes](https://www.postgresql.org/docs/current/btree-implementation.html)\n- [README.md in src/backend/access/nbtree](https://github.com/postgres/postgres/blob/master/src/backend/access/nbtree/README)",
      "outputs": [],
      "execution_count": null,
      "metadata": {}
    }
  ],
  "metadata": {
    "name": "PostgreSQL B-tree Fastpath ìµœì í™”",
    "created": "2026-02-28T00:00:00",
    "modified": "2026-02-28T00:00:00"
  },
  "session_state": null
}